name: Check Omkoi quota

on:
  schedule:
    - cron: "* * * * *" 
  workflow_dispatch:          # กด manual ได้

permissions:
  contents: write

concurrency:
  group: omkoi-quota
  cancel-in-progress: true

jobs:
  check-quota:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Get current time (UTC+7) and call API
        run: |
          set -euo pipefail

          DATE_TO_CHECK="2026-01-11"  # วันที่จะเช็ค (ปีคริสต์ศักราช)

          # เวลา UTC+7 (แค่ log สวย ๆ)
          TIMESTAMP=$(TZ=Asia/Bangkok date +"%Y-%m-%dT%H:%M:%S%z")

          # ติดตั้ง jq
          sudo apt-get update -y
          sudo apt-get install -y jq

          # เรียก API (fail ถ้า HTTP 4xx/5xx และ retry กันเน็ตสะดุด)
          RESPONSE=$(curl -fsS --retry 3 --retry-delay 2 \
            "https://wildlifesanctuaryfca16.com/api/omkoi/reservation/check-qty-people?start_date=${DATE_TO_CHECK}")

          echo "Timestamp: $TIMESTAMP"
          echo "Response: $RESPONSE"

          # ดึงค่า field จาก JSON
          QTY=$(echo "$RESPONSE" | jq -r '.data.qty')
          QTY_PEOPLE=$(echo "$RESPONSE" | jq -r '.data.qty_people')
          QTY_RESERVE=$(echo "$RESPONSE" | jq -r '.data.qty_reserve')

          echo "qty=$QTY qty_people=$QTY_PEOPLE qty_reserve=$QTY_RESERVE"

          # ✅ เขียนไฟล์เฉพาะตอน qty_reserve > 0
          if [ "$QTY_RESERVE" -le 0 ]; then
            echo "qty_reserve <= 0 → skip writing log"
            exit 0
          fi

          # เตรียมไฟล์ log
          LOG_FILE="omkoi_quota_log.csv"

          # ถ้ายังไม่มีไฟล์ ให้เขียน header ก่อน
          if [ ! -f "$LOG_FILE" ]; then
            echo "timestamp_utc7,start_date,qty,qty_people,qty_reserve" > "$LOG_FILE"
          fi

          # append log 1 บรรทัด
          echo "${TIMESTAMP},${DATE_TO_CHECK},${QTY},${QTY_PEOPLE},${QTY_RESERVE}" >> "$LOG_FILE"

      - name: Commit and push log (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep -q "omkoi_quota_log.csv"; then
            git add omkoi_quota_log.csv
            git commit -m "Update log at $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            git push
          else
            echo "No changes to commit."
          fi
